#!/usr/bin/env python3
# Copyright 2013, Big Switch Networks, Inc.
#
# LoxiGen is licensed under the Eclipse Public License, version 1.0 (EPL), with
# the following special exception:
#
# LOXI Exception
#
# As a special exception to the terms of the EPL, you may distribute libraries
# generated by LoxiGen (LoxiGen Libraries) under the terms of your choice, provided
# that copyright and licensing notices generated by LoxiGen are not altered or removed
# from the LoxiGen Libraries and the notice provided below is (i) included in
# the LoxiGen Libraries, if distributed in source code form and (ii) included in any
# documentation for the LoxiGen Libraries, if distributed in binary form.
#
# Notice: "Copyright 2013, Big Switch Networks, Inc. This library was generated by the LoxiGen Compiler."
#
# You may not use this file except in compliance with the EPL or LOXI Exception. You may obtain
# a copy of the EPL at:
#
# http://www.eclipse.org/legal/epl-v10.html
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# EPL for the specific language governing permissions and limitations
# under the EPL.
import unittest

try:
    import loxi
    import loxi.generic_util
    from loxi.generic_util import OFReader
except ImportError:
    exit("loxi package not found. Try setting PYTHONPATH.")

class TestUnpackList(unittest.TestCase):
    def test_simple(self):
        def deserializer(reader):
            length, = reader.peek("!B")
            return reader.read('!%ds' % length)[0]
        reader = loxi.generic_util.OFReader(b"\x04abc\x03de\x02f\x01")
        a = loxi.generic_util.unpack_list(reader, deserializer)
        self.assertEqual([b'\x04abc', b'\x03de', b'\x02f', b'\x01'], a)

class TestOFReader(unittest.TestCase):
    def test_simple(self):
        reader = OFReader(b"abcdefg")
        self.assertEqual(reader.read('2s')[0], b"ab")
        self.assertEqual(reader.read('2s')[0], b"cd")
        self.assertEqual(reader.read('3s')[0], b"efg")
        with self.assertRaisesRegex(loxi.ProtocolError, "Buffer too short"):
            reader.read('s')

    def test_skip(self):
        reader = OFReader(b"abcdefg")
        reader.skip(4)
        self.assertEqual(reader.read('s')[0], b"e")
        with self.assertRaisesRegex(loxi.ProtocolError, "Buffer too short"):
            reader.skip(3)

    def test_empty(self):
        reader = OFReader(b"abcdefg")
        self.assertEqual(reader.is_empty(), False)
        reader.skip(6)
        self.assertEqual(reader.is_empty(), False)
        reader.skip(1)
        self.assertEqual(reader.is_empty(), True)
        with self.assertRaisesRegex(loxi.ProtocolError, "Buffer too short"):
            reader.skip(1)

    def test_exception_effect(self):
        reader = OFReader(b"abcdefg")
        with self.assertRaisesRegex(loxi.ProtocolError, "Buffer too short"):
            reader.skip(8)
        self.assertEqual(reader.is_empty(), False)
        reader.skip(7)
        self.assertEqual(reader.is_empty(), True)

    def test_peek(self):
        reader = OFReader(b"abcdefg")
        self.assertEqual(reader.peek('2s')[0], b"ab")
        self.assertEqual(reader.peek('2s')[0], b"ab")
        self.assertEqual(reader.read('2s')[0], b"ab")
        self.assertEqual(reader.peek('2s')[0], b"cd")
        reader.skip(2)
        self.assertEqual(reader.read('3s')[0], b"efg")
        with self.assertRaisesRegex(loxi.ProtocolError, "Buffer too short"):
            reader.peek('s')

    def test_read_all(self):
        reader = OFReader(b"abcdefg")
        reader.skip(2)
        self.assertEqual(reader.read_all(), b"cdefg")
        self.assertEqual(reader.read_all(), b"")

    def test_slice(self):
        reader = OFReader(b"abcdefg")
        reader.skip(2)
        self.assertEqual(reader.slice(3).read_all(), b"cde")
        self.assertEqual(reader.slice(2).read_all(), b"fg")
        self.assertEqual(reader.is_empty(), True)

    def test_skip_align(self):
        reader = OFReader(b"abcd" + b"efgh" + b"ijkl" + b"mnop" + b"qrst")
        reader.skip_align()
        self.assertEqual(reader.peek('2s')[0], b'ab')
        self.assertEqual(reader.read('2s')[0], b"ab")
        reader.skip_align()
        self.assertEqual(reader.peek('2s')[0], b'ij')
        self.assertEqual(reader.read('2s')[0], b'ij')
        child = reader.slice(10)
        self.assertEqual(child.read('2s')[0], b'kl')
        child.skip_align()
        self.assertEqual(child.peek('2s')[0], b'st')

if __name__ == '__main__':
    unittest.main()
